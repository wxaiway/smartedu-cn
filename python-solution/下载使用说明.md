# 批量下载使用说明

参考项目 https://github.com/happycola233/tchMaterial-parser/blob/main/src/tchMaterial-parser.pyw 思路

## 整合版下载器

现在只提供一个整合版的下载器：
- `batch_downloader.py` - 整合版，支持所有类型教材和多媒体资源

整合版特性：
1. 自动识别专题课程(thematic_course)类型
2. 支持从专题课程API获取PDF
3. 智能提取并下载音频资源（MP3）
4. CDN自动切换，提高下载成功率
5. 请求速率限制，避免被封
6. 完整的任务过滤和重试机制
7. 详细的错误处理和日志

## 准备工作

### 1. 获取Access Token

1. 使用浏览器登录 https://auth.smartedu.cn/uias/login
2. 安装并运行 Tampermonkey 脚本 `smartedu-pdf-direct-extractor.user.js`
3. 打开任意教材页面，脚本会自动显示Token
4. 复制Token备用

### 2. 生成下载任务

如果还没有生成任务列表，运行：

```bash
python generate_download_tasks.py
```

这会生成 `download_tasks.json` 文件，包含所有3,471个下载任务。

## 下载教材

### 基本用法

下载所有教材到默认目录（教材库）：
```bash
# 下载所有教材（含音频）
python batch_downloader.py --token "你的Token"

# 仅下载PDF（最快）
python batch_downloader.py --token "你的Token" --no-multimedia
```

### 高级选项

1. **指定下载目录**
```bash
# 下载到指定目录
python batch_downloader.py --token "你的Token" --output /path/to/教材

# 使用短选项
python batch_downloader.py --token "你的Token" -o ~/Documents/教材库
```

2. **按学段下载**
```bash
# 只下载小学教材
python batch_downloader.py --token "你的Token" --stage 小学

# 只下载初中教材
python batch_downloader.py --token "你的Token" --stage 初中

# 只下载教学指南
python batch_downloader.py --token "你的Token" --stage 教学指南
```

3. **按学科下载**
```bash
# 只下载语文教材
python batch_downloader.py --token "你的Token" --subject 语文

# 只下载数学教材
python batch_downloader.py --token "你的Token" --subject 数学
```

4. **按版本下载**
```bash
# 只下载人教版
python batch_downloader.py --token "你的Token" --version 人教

# 只下载北师版
python batch_downloader.py --token "你的Token" --version 北师
```

5. **组合条件**
```bash
# 下载小学语文人教版
python batch_downloader.py --token "你的Token" --stage 小学 --subject 语文 --version 人教
```

6. **限制数量（用于测试）**
```bash
# 只下载前10个
python batch_downloader.py --token "你的Token" --limit 10
```

7. **调整并发数和速率**
```bash
# 使用5个线程（默认3个）
python batch_downloader.py --token "你的Token" --workers 5

# 调整请求速率（默认2.0/秒）
python batch_downloader.py --token "你的Token" --rate-limit 5.0

# 禁用速率限制（不推荐）
python batch_downloader.py --token "你的Token" --no-ratelimit
```

8. **简单模式（禁用高级功能）**
```bash
# 禁用重试和速率限制
python batch_downloader.py --token "你的Token" --no-retry --no-ratelimit
```

## 测试Token

在正式下载前，可以先测试Token是否有效：

```bash
python test_downloader.py
```

按提示输入Token，脚本会测试API访问和PDF下载权限。

## 下载说明

1. **下载位置**：所有文件保存在 `教材库/` 目录下，按学段、学科、版本等分类存放

2. **断点续传**：程序会自动跳过已下载的文件（通过文件大小判断）

3. **失败重试**：失败的任务会记录在 `failed_tasks.json` 中

4. **日志文件**：详细日志保存在 `logs/` 目录

## 重试失败的任务

如果有下载失败的任务，会保存在 `failed_tasks.json` 文件中。可以使用以下命令重试：

```bash
# 重试失败的任务
python batch_downloader.py --token "你的Token" --retry-failed

# 重试失败任务并指定输出目录
python batch_downloader.py --token "你的Token" --retry-failed --output /path/to/教材

# 重试失败任务，但只尝试前10个
python batch_downloader.py --token "你的Token" --retry-failed --limit 10

# 重试失败任务，使用更多线程
python batch_downloader.py --token "你的Token" --retry-failed --workers 5
```

注意：在重试模式下，stage、subject、version 等过滤参数会被忽略。

## 目录结构

下载后的目录结构示例：
```
教材库/
├── 小学/
│   ├── 语文/
│   │   ├── 人教/
│   │   │   ├── 1年级/
│   │   │   │   ├── 上/
│   │   │   │   │   └── 语文_1年级_上_人教.pdf
│   │   │   │   └── 下/
│   │   │   │       └── 语文_1年级_下_人教.pdf
├── 初中/
├── 高中/
├── 特教/
├── 教师用书/
└── 教学指南/
```

## 注意事项

1. **Token有效期**：Token可能会过期，如果下载失败请重新获取

2. **网络要求**：需要稳定的网络连接，建议在网络较好的环境下载

3. **存储空间**：全部教材约需要200GB+存储空间

4. **下载速度**：取决于网络状况和服务器响应，一般每个文件需要几秒到几十秒

5. **合理使用**：请合理控制下载速度，避免对服务器造成压力

## 多媒体资源

整合版下载器默认支持下载教材中的音频资源（MP3）：

### 控制多媒体下载
```bash
# 默认行为：下载教材和音频资源
python batch_downloader.py --token "你的Token"

# 仅下载PDF，跳过音频资源（最快）
python batch_downloader.py --token "你的Token" --no-multimedia

# 下载英语教材及其音频
python batch_downloader.py --token "你的Token" --subject 英语
```

### 音频资源组织方式
```
教材库/
├── 小学/
│   ├── 英语/
│   │   ├── 人教/
│   │   │   ├── 3年级/
│   │   │   │   └── 上/
│   │   │   │       ├── 英语_3年级_上_人教.pdf
│   │   │   │       └── 英语_3年级_上_人教_音频/
│   │   │   │           ├── Unit 1/
│   │   │   │           │   ├── Lesson 1/
│   │   │   │           │   │   ├── AUDIO-1_Listen and say.mp3
│   │   │   │           │   │   └── AUDIO-2_Listen and chant.mp3
│   │   │   │           │   └── Lesson 2/
│   │   │   │           │       └── AUDIO-3_Listen and sing.mp3
│   │   │   │           └── Unit 2/
│   │   │   │               └── Lesson 1/
│   │   │   │                   └── AUDIO-4_Listen and repeat.mp3
```

### 注意事项
- 音频资源主要存在于语言类教材（英语、语文等）
- 如果不需要音频资源，使用 `--no-multimedia` 参数可加快下载速度
- 多媒体资源信息会保存到 `multimedia_resources.json` 文件中
- 音频文件会按照Unit/Lesson结构组织，方便查找和使用

### 视频资源说明
平台的视频资源都有DRM保护，无法直接下载。程序会：
1. 自动识别并跳过DRM加密的视频
2. 记录视频信息到 `multimedia_resources.json` 中
3. 只下载可用的音频资源（MP3格式）

## 常见问题

### 1. Token无效
- 重新登录平台
- 使用Tampermonkey脚本获取新Token

### 2. 下载速度慢
- 减少并发数：`--workers 2`
- 检查网络连接

### 3. 部分文件下载失败
- 查看 `failed_tasks.json`
- 可能是权限问题或资源暂时不可用
- 某些体育类教材是专题课程，程序会自动处理

### 4. 如何恢复下载
- 程序会自动跳过已下载文件
- 直接重新运行相同命令即可

### 5. "无法获取PDF URL"错误
- 某些教材（如体育类）是专题课程格式
- 整合版下载器会自动处理不同类型的资源
- 如果确实没有PDF，可能只有多媒体资源

### 6. CDN切换说明
- 程序会自动在3个CDN节点间切换
- 如果一个节点失败，会尝试其他节点
- 提高了下载成功率

## 统计信息

根据任务列表，教材分布如下：
- 总数：3,471本
- 小学：1,530本
- 初中：875本
- 高中：511本
- 特殊教育：289本
- 小学（五•四学制）：110本
- 初中（五•四学制）：156本

主要学科：
- 音乐：662本
- 美术：523本
- 英语：408本（大部分包含音频）
- 体育：337本
- 数学：252本
- 语文：188本（部分包含音频）
- 科学：194本

## 完整参数说明

```bash
python batch_downloader.py --help
```

主要参数：
- `--token`: 必需，认证Token
- `--tasks`: 任务文件路径（默认：download_tasks.json）
- `--output, -o`: 输出目录（默认：教材库）
- `--workers`: 并发下载数（默认：3）
- `--stage`: 只下载指定学段
- `--subject`: 只下载指定学科
- `--version`: 只下载指定版本
- `--limit`: 限制下载数量
- `--retry-failed`: 重试失败的任务
- `--no-multimedia`: 仅下载PDF，跳过音频
- `--no-retry`: 禁用失败重试
- `--no-ratelimit`: 禁用速率限制
- `--rate-limit`: 每秒最大请求数（默认：2.0）